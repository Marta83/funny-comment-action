{"version":3,"file":"index.js","sources":["../dist-src/validate-specifier.js","../dist-src/index.js"],"sourcesContent":["function getLineCol(node) {\n    const loc = node.loc.start;\n    //   return chalk.dim(`[${loc.line}:${loc.column}]`);\n    return `[${loc.line}:${loc.column}]`;\n}\nexport function validateDynamicImportArguments(path) {\n    if (path.parent.arguments.length !== 1) {\n        return new Set([\n            `${getLineCol(path.node)} \"\\`import()\\` only accepts 1 argument, but got ${path.parent.arguments.length}`,\n        ]);\n    }\n    const [argNode] = path.parent.arguments;\n    if (argNode.type !== 'StringLiteral') {\n        return new Set([\n            `${getLineCol(path.node)} Pika expects strings as \\`import()\\` arguments. Treating this as an absolute file path.`,\n        ]);\n    }\n    return new Set();\n}\n","import nodeFs from 'fs';\nimport url from 'url';\nimport nodePath from 'path';\nimport { validateDynamicImportArguments } from './validate-specifier.js';\nconst BareIdentifierFormat = /^((?:@[^\\/]+\\/)?[^\\/]+)(\\/.*)?$/;\nexport default function transform({}) {\n    function rewriteImport(specifier, { opts, file }) {\n        const { deps, addExtensions } = opts;\n        try {\n            url.parse(specifier);\n        }\n        catch (err) {\n            return;\n        }\n        // URL w/o protocol\n        if (specifier.substr(0, 2) === '//') {\n            return; // Leave it alone\n        }\n        // Local path\n        if (['.', '/'].indexOf(specifier.charAt(0)) >= 0) {\n            if (addExtensions) {\n                const extname = nodePath.extname(specifier);\n                if (extname === '.js') {\n                    return;\n                }\n                if (extname) {\n                    console.warn('Unexpected file extension:', specifier);\n                    return;\n                }\n                const resolvedPath = nodePath.resolve(nodePath.dirname(file.opts.filename), specifier);\n                try {\n                    const stat = nodeFs.lstatSync(resolvedPath);\n                    if (stat.isDirectory()) {\n                        return specifier + '/index.js';\n                    }\n                }\n                catch (err) {\n                    // do nothing\n                }\n                return specifier + '.js';\n            }\n            return;\n        }\n        // A 'bare' identifier\n        const match = BareIdentifierFormat.exec(specifier);\n        if (deps && match) {\n            const packageName = match[1];\n            // const file = match[2] || '';\n            return deps[packageName];\n        }\n    }\n    return {\n        visitor: {\n            'ImportDeclaration|ExportNamedDeclaration|ExportAllDeclaration'(path, { opts, file }) {\n                if (!path.node.source) {\n                    return;\n                }\n                const rewrittenSpecifier = rewriteImport(path.node.source.value, { opts, file });\n                if (rewrittenSpecifier) {\n                    path.node.source.value = rewrittenSpecifier;\n                }\n            },\n            Import(path, { opts, file }) {\n                const errors = validateDynamicImportArguments(path);\n                if (errors.size > 0) {\n                    return;\n                }\n                const [importPath] = path.parent.arguments;\n                const rewrittenSpecifier = rewriteImport(importPath.value, { opts, file });\n                if (rewrittenSpecifier) {\n                    importPath.value = rewrittenSpecifier;\n                }\n            },\n        },\n    };\n}\n"],"names":["getLineCol","node","loc","start","line","column","validateDynamicImportArguments","path","parent","arguments","length","Set","argNode","type","BareIdentifierFormat","transform","rewriteImport","specifier","opts","file","deps","addExtensions","url","parse","err","substr","indexOf","charAt","extname","nodePath","console","warn","resolvedPath","resolve","dirname","filename","stat","nodeFs","lstatSync","isDirectory","match","exec","packageName","visitor","source","rewrittenSpecifier","value","Import","errors","size","importPath"],"mappings":"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"}